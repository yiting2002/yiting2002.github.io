<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta property="og:image" content="112_0_0_0.png" />
    <title>PixARK #112</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
      #legend {
        font-family: monospace;
        background-color: #fff;
        padding: 10px;
        margin: 20px;
        border: 3px solid #000;
        font-size: large;
      }
      #legend ul {
        list-style-type: none;
        padding: 0;
        margin: 0;
      }
      #legend li {
        padding: 3px;
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="legend">
      <a style="font-weight:bold;color:#00F;text-decoration:initial;" target="_blank" href="https://docs.google.com/spreadsheets/d/15LwlFt2_sJv8l3_-Uu6fyssOL9_EuE2-DpF4OcDjcr8/edit">[+增加標記]</a>
      <br/><br/>
      <ul>
      <li><span style="color:#75654b">▇</span> 末日之地</li>
      <li><span style="color:#425a5f">▇</span> 黑暗森林</li>
      <li><span style="color:#b3ffdd">▇</span> 冰封之地</li>
      <li><span style="color:#a27f27">▇</span> 黃金秘境</li>
      <li><span style="color:#7171ff">▇</span> 魔法森林</li>
      <li><span style="color:#ffff62">▇</span> 沙漠</li>
      <li><span style="color:#2e962b">▇</span> 沼澤</li>
      <li><span style="color:#22692e">▇</span> 高山林地</li>
      <li><span style="color:#4dc82e">▇</span> 草原</li>
      <li><span style="color:#7eea35">▇</span> 新手草原</li>
      <li><span style="color:#00fbff">▇</span> 深海</li>
      </ul>
    </div>
    <script>
      var gMap, gWindow, gMarkers = new Array();
      var gIconN, gIconS;

      function initMarker(marker) {
        marker.addListener('click',function() {
          var l = marker.getLabel().text;
          for (var i = 0; i < gMarkers.length; i++) {
            if (gMarkers[i].getLabel().text == l) {
              gMarkers[i].setIcon(gIconS);
              gMarkers[i].setZIndex(google.maps.Marker.MAX_ZINDEX+1);
              if (gMarkers[i] == marker) {
                gWindow.setContent(marker.getTitle().replace('\n','<br/>'));
                gWindow.open(gMap, marker);
              }
            }
            else if (gMarkers[i].getZIndex() != null) {
              gMarkers[i].setIcon(gIconN);
              gMarkers[i].setZIndex(null);
            }
          }
        });
        gMarkers.push(marker);
      }

      function initSheet(data) {
        for (var i = 1; i < data.values.length; i++) {
          var row = data.values[i];
          if (row.length < 3 || row[0] == '' || row[1] == '' || row[2] == '') continue;
          var title = '['+row[1]+', '+row[2]+']';
          if (row.length > 3 && row[3] != '') title += '\n'+row[3];
          var label = {text: row[0], color: '#FFF'};
          var pos = {lat: parseFloat(row[2]) / 8000, lng: parseFloat(row[1]) / 8000};
		  var shape = {type: 'poly', coords: [-2,7,5,0,18,0,25,7,25,20,17,43,10,43,-2,20]};
          initMarker(new google.maps.Marker({
            position: pos,
            icon: gIconN,
			shape: shape,
            label: label,
            title: title,
            map: gMap
          }));
        }
      }

      function initMap() {
        gMap = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 0, lng: 0},
          zoom: 2,
          streetViewControl: false,
          mapTypeControl: false,
		  rotateControl: false
        });

        var mapType = new google.maps.ImageMapType({
          getTileUrl: function(coord, zoom) {
            zoom -= 1;
            if (zoom < 0) return null;
            var scale = 1 << zoom;
            if (coord.x < 0 || coord.x >= scale) return null;
            if (coord.y < 0 || coord.y >= scale) return null;
            return '112_'+zoom+'_'+coord.x+'_'+coord.y+'.png';
          },
          tileSize: new google.maps.Size(450, 450),
          isPng: true,
          maxZoom: 3,
          minZoom: 1,
          name: 'PixARK'
        });

        mapType.projection = {
          fromLatLngToPoint: function(latLng) {
            return new google.maps.Point(
              (latLng.lng() + 0.25) * 450,
              (latLng.lat() + 0.25) * 450);
          },
          fromPointToLatLng: function(point, noWrap) {
            return new google.maps.LatLng(
              (point.y / 450) - 0.25,
              (point.x / 450) - 0.25, true);
          }
        };

        gMap.mapTypes.set('pixark', mapType);
        gMap.setMapTypeId('pixark');
        gMap.controls[google.maps.ControlPosition.LEFT_CENTER].push(document.getElementById('legend'));

        gIconN = {
          url: 'data:image/svg+xml;utf8,<svg width="27" height="43" viewBox="16 16 108 172" xmlns="http://www.w3.org/2000/svg"><path d="M70,18C108,18 139,60 111,102S77,158 76,174S65,190 64,174S57,144 29,102S32,18 70,18Z" stroke-width="4" stroke="#ffffff" fill="#ea4335"/></svg>',
          anchor: new google.maps.Point(13.5,42),
          labelOrigin: new google.maps.Point(13,15)
        };
        gIconS = {
          url: 'data:image/svg+xml;utf8,<svg width="27" height="43" viewBox="16 16 108 172" xmlns="http://www.w3.org/2000/svg"><path d="M70,18C108,18 139,60 111,102S77,158 76,174S65,190 64,174S57,144 29,102S32,18 70,18Z" stroke-width="6" stroke="#ffffff" fill="#ca35ea"/></svg>',
          anchor: new google.maps.Point(13.5,42),
          labelOrigin: new google.maps.Point(13,15)
        };
        gWindow = new google.maps.InfoWindow();
        gWindow.addListener('closeclick',function() {
          for (var i = 0; i < gMarkers.length; i++) {
            if (gMarkers[i].getZIndex() != null) {
              gMarkers[i].setIcon(gIconN);
              gMarkers[i].setZIndex(null);
            }
          }
        });

        var sheet = document.createElement('script');
        sheet.type = 'text/javascript';
        sheet.src = 'https://sheets.googleapis.com/v4/spreadsheets/15LwlFt2_sJv8l3_-Uu6fyssOL9_EuE2-DpF4OcDjcr8/values/map!A:D?key=AIzaSyBokzsCC_kJcT22Uw3cTzilwXLVkqQarKs&callback=initSheet';
        document.getElementsByTagName('head')[0].appendChild(sheet);
      }
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBokzsCC_kJcT22Uw3cTzilwXLVkqQarKs&callback=initMap">
    </script>
  </body>
</html>
